<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Capture Test</title>
</head>

<body>
    <video id="video" autoplay style="width: 480px;height: 320px"></video>
    <div>
        <button id="capture" onclick="handleClickCapture()">capture</button>
    </div>

    <canvas id="canvas" width="480" height="320"></canvas>
</body>


<script>
    var video = document.getElementById('video');
    var capture = document.getElementById('capture');
    var ctx = document.getElementById('canvas').getContext('2d');

    function getUserMediaToPhoto(constraints, success, error) {
        if (navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia(constraints).then(success).catch(error);
        } else if (navigator.webkitGetUserMedia) {
            navigator.webkitGetUserMedia(constraints, success, error);
        } else if (navigator.mozGetUserMedia) {
            navigator.mozGetUserMedia(constraints, success, error);
        } else if (navigator.getUserMedia) {
            navigator.getUserMedia(constraints, success, error);
        }
    }

    function success(stream) {
        var CompatibleURL = window.URL || window.webkitURL;
        try {
            video.src = CompatibleURL.createObjectURL(stream);
        } catch (e) {
            video.srcObject = stream;
        }
        video.play();
    }

    function error(error) {
        console.log('error', error);
    }

    if (navigator.mediaDevices.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.getUserMedia) {
        getUserMediaToPhoto({video: {width: 480, height: 320}}, success, error);
    } else {
        alert('Media not supported');
    }

    function base64ToBlob(code) {
		let parts = code.split(';base64,');
		let contentType = parts[0].split(':')[1];
		let raw = window.atob(parts[1]);
		let rawLength = raw.length;

		let uInt8Array = new Uint8Array(rawLength);

		for (let i = 0; i < rawLength; ++i) {
		    uInt8Array[i] = raw.charCodeAt(i);
		}
		return new Blob([uInt8Array], {type: contentType});
	}

    function downloadFile(fileName, content) {
		let aLink = document.createElement('a');
	    let blob = this.base64ToBlob(content); 

	    let evt = document.createEvent("HTMLEvents");
	    evt.initEvent("click", true, true);
	    aLink.download = fileName;
	    aLink.href = URL.createObjectURL(blob);

	    aLink.dispatchEvent(new MouseEvent('click', {bubbles: true, cancelable: true, view: window}));
    }

    function handleClickCapture() {
        ctx.drawImage(video, 0, 0, 480, 320);
        var image = ctx.canvas.toDataURL();
        downloadFile('statement1.png', image);
    }

</script>

</html>